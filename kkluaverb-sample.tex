\documentclass{ltjsarticle}
\usepackage{luwa-ul}
\usepackage{KKluaverb}
\usepackage{tabularray, booktabs, array}
\usepackage{makeidx, amsmath}
\usepackage[most]{tcolorbox}

\makeatletter
\def\ascb@zw#1#2{#1\zw}
\def\ascb@gtfamily{\gtfamily}
\newcommand{\ascb@parindent}[1]{%
  \setlength{\parindent}{#1}\relax%
}
\newdimen\ascb@parindent@dimen
\ascb@parindent@dimen=\zw
\DeclareTColorBox{simple}{ o m O{.5} O{} }% 
{empty, left=2mm, right=2mm, top=-1mm, 
attach boxed title to top left={xshift=\ascb@zw{1.2}{11pt}}, 
boxed title style={empty,left=-1mm,right=-1mm}, colframe=black, coltitle=black, coltext=black, breakable, 
before upper={\ascb@parindent{\ascb@parindent@dimen}},%%%
underlay unbroken={\draw[black,line width=#3pt](title.east) -- (title.east-|frame.east) -- (frame.south east) -- (frame.south west) -- (title.west-|frame.west) -- (title.west); },
underlay first={\draw[black,line width=#3pt](title.east) -- (title.east-|frame.east) -- (frame.south east) ;
\draw[black,line width=#3pt] (frame.south west) -- (title.west-|frame.west) -- (title.west); },
underlay middle={\draw[black,line width=#3pt](frame.north east) -- (frame.south east) ;
\draw[black,line width=#3pt](frame.south west) -- (frame.north west) ;},
underlay last={\draw[black,line width=#3pt](frame.north east) -- (frame.south east) -- (frame.south west) -- (frame.north west) ;},
fonttitle=\ascb@gtfamily, IfValueTF={#1}{title=【#2】〈#1〉}{title=【#2】, #4}}
\makeatother

\KKvSetMap{ }{␣}
\KKvSetMap{。}{．}
\KKvSetMap{、}{，}
\KKvSetMap{A}{[A-mapped]}
\KKvSetMap{!}{〈EXCLAMATION〉}

\begin{luacode*}
  KKLuaVerb.presets["TeXStyle"] = {
    map = { 
      DarkCyan = { "{", "}" },              
      OrangeRed = { "[", "]" },
      DeepPink = { "(", ")" },              
      DarkGoldenrod = { "&", "$", "^", "_"},

      CornflowerBlue = { 
        "\\documentclass", "\\usepackage", "\\begin", "\\end", 
        "\\section", "\\subsection", "\\chapter", 
        "\\makeatletter", "\\makeatother", "\\ExplSyntaxOn", "\\ExplSyntaxOff" 
      },
      
      MediumPurple = { 
        "\\def", "\\edef", "\\gdef", "\\xdef", 
        "\\newcommand", "\\renewcommand", "\\providecommand",
        "\\let", "\\setcopy", "\\long", "\\global"
      },

      Magenta = { 
        "\\if", "\\else", "\\fi", "\\ifx", "\\ifdefined", 
        "\\ifnum", "\\ifdim", "\\loop", "\\repeat"
      },
    }, 
    
    options = { 
      word_boundary = true,  
      comment_char = "%",     
      comment_color = "ForestGreen", 
      escape_char = "\\",
      delimiters = {
        { start = '$', stop = '$', color = "SpringGreen3" },
      }       
    }
  }
\end{luacode*}

\begin{luacode*}
  KKLuaVerb.presets["LuaStyle"] = {
    map = { 
      Magenta = { 
        "if", "then", "else", "elseif", "end", 
        "for", "while", "repeat", "until", "in",
        "do", "break", "return", "function" 
      },

      ProcessBlue = { "local", "true", "false", "nil" },
      DarkGoldenrod = { 
        "print", "require", "type", "tostring", "tonumber",
        "table", "string", "math", "io", "os", "debug", "coroutine",
        "self" 
      },

      DarkCyan = { "{", "}", "[", "]", "(", ")", "=", "+", "-", "*", "/", "#", "..", "==" }
    },
    options = { 
      word_boundary = true,   
      comment_char = "--",     
      comment_color = "Cerulean", 
      escape_char = "%",
      delimiters = {
        { start = '"', stop = '"', color = "SkyBlue1" },
      }      
    }
  }
\end{luacode*}

\makeindex

\begin{document}
\KKvUsePreset{TeXStyle}

\tableofcontents
\listoftables

\section{Basic Mapping \& Edge Cases}

\KKverb|Hello World!| 

\KKverb|      Leading and trailing spaces      |

\KKverb|A!A!A!A!A|

\KKverb|# $ $ % ^ & _ { } ~ \ |

\KKverb|!!。。、、  !!|

\section{Nesting with \texttt{luwa-ul}}

\underLineKK{Normal Text \KKverb|Verb Text with Space| Normal Text}

\underLineKK{Normal Text \KKverb|Verb Text with 
 Space| Normal Text}

\underLineKK{\KKvOpChange{color=blue}\KKverb|Blue underline with A and !|}

\underLineKK{
  \KKverb|Multi-line|
  \underLineKK{\KKvOpChange{color=red}\KKverb|Nested Red Underline|}
  \KKverb|Back to Normal|
}

\section{Complex Structures (Tables \& Lists)}

\begin{table}[h]
\caption{移動引数テスト: \KKverb|Caption \ # %|}
\begin{tblr}{
  colspec={Q[m,c] X[l,m]}, % X列に m (middle) を追加。これで段落モードが有効になります
  hlines, vlines,
  row{1}={bg=gray9, font=\bfseries}
}
項 & テスト内容 \\
1 & \KKverb|Standard Verb| \\
2 & \underLineKK{\KKverb|Underlined Verb in Table|} \\
3 & 
\KKcodeS+
Line 1
Line 2 with space
Line 3
\KKcodeE \\
4 & \KKverb|Special Chars: { } [ ] < > ( )| \\
\end{tblr}
\end{table}

\begin{itemize}
  \item[\KKverb|Point 1|] \KKverb|Description with 。 and 、|
  \item[\underLineKK{\KKverb|Point 2|}] \underLineKK{\KKverb|Underlined Item Label| \index{item@\KKverb|item|}}
\end{itemize}

\section{Advanced Multi-line \& Box Stress Test}

%%% Remain to be enhanced...
\begin{simple}{Multi-language Code Test (Numbered)}\KKvUsePreset{LuaStyle}
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ%
{\KKvLNChange{start=15}%
\KKcodeS+
function hello() { 
  print("こんにちは、世界。"); -- space check
  return A + 1; !
}

-- Testing Long Sentence
This is a long sentence that should potentially wrap or be handled by the line break settings of the package. 
和文と英文が混ざった状態で。句点。と、読点、の置換。
ただの和文のテストコード。
ここにグルーが入ってズレてほしくない。
abcみたいな英字でも、
123みたいな数字でも。
\KKcodeE}
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ%
\end{simple}

\begin{simple}{Multi-language Code Test (Not Numbered)}
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ%

\KKcodeS

function hello() {
  print("こんにちは、世界。"); -- space check
  return A + 1; !
}

-- Testing Long Sentence
This is a long sentence that should potentially wrap or be handled by the line break settings of the package. 
和文と英文が混ざった状態で。句点。と、読点、の置換。
ただの和文のテストコード。
ここにグルーが入ってズレてほしくない。
abcみたいな英字でも、
123みたいな数字でも。

\KKcodeE
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ
ああああああああああああああああああああ%
\end{simple}

\section{Indexing Strategy Test}
\KKvUsePreset{TeXStyle}

\index{Alphabet@\KKverb|Alphabet Mapping: A|}
\index{Symbol@\KKverb|Symbol: # $ $ % &|}
\index{Japanese@\KKverb|和文。置換、テスト|}

\KKverb|Check the index for A, !, 。, and 、|

\section{Deep Grouping \& Scoping}

{
  \KKvSetMap{ }{[SPACE]}
  \KKvSetMap{。}{[PERIOD]}
  \KKverb|Scoped Map Test。|
}

\KKverb|Back to Global Map Test。|

\section{Extreme Math/Macro Integration}

Use \KKverb|\KKverb| in a mathmode:
\begin{equation}
  \text{Equation with Verb: } \mbox{\underLineKK{\KKverb|E = mc^2 \alpha \beta \gamma|}}
\end{equation}

Normal math mode:
\begin{equation}
  \text{Equation with Verb: } E = mc^2 \alpha \beta \gamma
\end{equation}

Foot note\footnote{Footnote Test: \KKverb|Verb in footnote #%| and \underLineKK{\KKverb|underlined|}}.

\printindex

\end{document}