\documentclass[luatex,fontsize=8pt,paper=b5,twoside]{jlreq}%
\usepackage{amsmath,amssymb}
\usepackage{booktabs,caption}
\usepackage{luwa-ul}
\usepackage{KKsymbols}
\usepackage[most]{tcolorbox}
\usepackage{KKluaverb}

%%% fonts (This can be omitted.)
\makeatletter 
\RequirePackage[no-math]{fontspec}
\RequirePackage[no-math,match,scale=1]{luatexja-fontspec}
\RequirePackage[hiragino-pro,deluxe,expert]{luatexja-preset}
\setmainfont{HiraMinPro-W3}[BoldFont=HiraMinPro-W6]
\setmainjfont{HiraMinPro-W3}[BoldFont=HiraMinPro-W6]
\newfontfamily{\sfhira@pre}{HiraKakuPro-W3}[BoldFont=HiraKakuPro-W6]
\newjfontfamily{\sfhiraj@pre}{HiraKakuPro-W3}[BoldFont=HiraKakuPro-W6]
\newfontfamily{\mchira@pre}{HiraMinPro-W3}[BoldFont=HiraMinPro-W6]
\newjfontfamily{\mchiraj@pre}{HiraMinPro-W3}[BoldFont=HiraMinPro-W6]
\newfontfamily{\gthira@pre}{HiraKakuPro-W3}[BoldFont=HiraKakuPro-W6,FontFace={eb}{\shapedefault}{HiraKakuStd-W8}]
\newjfontfamily{\gthiraj@pre}{HiraKakuPro-W3}[BoldFont=HiraKakuPro-W6,FontFace={eb}{\shapedefault}{HiraKakuStd-W8}]
\newfontfamily{\mghira@pre}{HiraMaruPro-W4}
\newjfontfamily{\mghiraj@pre}{HiraMaruPro-W4}
\renewcommand{\sffamily}{\sfhira@pre\sfhiraj@pre}
\renewcommand{\mcfamily}{\mchira@pre\mchiraj@pre}
\renewcommand{\gtfamily}{\gthira@pre\gthiraj@pre}
\renewcommand{\mgfamily}{\mghira@pre\mghiraj@pre}
\makeatother
%%%


%%% hyperref
\usepackage{hyperref} 
\hypersetup{
  luatex, pdfencoding=auto, 
  colorlinks=true,
  linkcolor=black,     
  citecolor=black,     
  urlcolor=DeepSkyBlue3,      
  pdfborder={0 0 0}, 
}
%%%


%%% textboxes
\makeatletter
\newcommand{\ascb@parindent}[1]{%
  \setlength{\parindent}{#1}\relax%
}
\def\ascb@gtfamily{\gtfamily}\def\ascb@zw#1#2{#1\zw}
\DeclareTColorBox{simple}{ o m O{.5} O{} }% 
{empty, left=2mm, right=2mm, top=-1mm, 
attach boxed title to top left={xshift=\ascb@zw{1.2}{11pt}}, 
boxed title style={empty,left=-2mm,right=-2mm}, colframe=black, coltitle=black, coltext=black, breakable, 
before upper={\ascb@parindent{\zw}},%%%
underlay unbroken={\draw[black,line width=#3pt](title.east) -- (title.east-|frame.east) -- (frame.south east) -- (frame.south west) -- (title.west-|frame.west) -- (title.west); },
underlay first={\draw[black,line width=#3pt](title.east) -- (title.east-|frame.east) -- (frame.south east) ;
\draw[black,line width=#3pt] (frame.south west) -- (title.west-|frame.west) -- (title.west); },
underlay middle={\draw[black,line width=#3pt](frame.north east) -- (frame.south east) ;
\draw[black,line width=#3pt](frame.south west) -- (frame.north west) ;},
underlay last={\draw[black,line width=#3pt](frame.north east) -- (frame.south east) -- (frame.south west) -- (frame.north west) ;},
fonttitle=\ascb@gtfamily, IfValueTF={#1}{title=\hspace*{.1em}【#2】〈#1〉\hspace*{.1em}}{title=\hspace*{.1em}【#2】\hspace*{.1em}},#4}
\def\KKfbox@SourceCode@phantom{\vphantom{あ}\vphantom{j}}
\NewTCBListing{SourceCode}{ m m !o !O{DeepSkyBlue3} }{%
  enhanced, colback=black!70, colframe=Snow4,
  toptitle=-1mm, bottomtitle=-1mm,
  righttitle=-1mm, lefttitle=-1mm,
  arc=.5mm, 
  title={\tcbox[on line, arc=.5mm, boxsep=0pt, boxrule=0pt, 
    top=1mm, bottom=0.8mm, left=2mm, right=2.2mm, 
    colback=gray!80, coltext=white]{%
    \raisebox{-.04\zw}{\KKfbox@SourceCode@phantom#1}}%
  },
  fonttitle=\gtfamily\footnotesize, boxrule=0.8pt,
  breakable, before upper={\color{white}}, top=-0.5mm, bottom=-0.5mm,
  after title=\IfNoValueTF{#3}{}{{\hfill%
    \tcbox[on line, arc=.5mm, boxsep=0pt, boxrule=0pt, 
    top=1mm, bottom=0.8mm, left=2mm, right=2.2mm, 
    colback=white!80!black, coltext=#4]{\raisebox{-.04\zw}{\KKfbox@SourceCode@phantom#3}}}%
  },
  listing only,
  listing options={
    language={#2},
    basicstyle=\ttfamily,
    keywordstyle=\ttfamily\color{white},
    stringstyle=\itshape\color{white},
    commentstyle=\small\gtfamily\color{DeepSkyBlue2},
    showspaces=false,showtabs=false,
    breaklines=true,breakindent=0pt,
    showstringspaces=false,
    columns=fullflexible,
    tabsize=2,
    numbers=left,numbersep=1.5pt,
    numberstyle=\scriptsize\gtfamily\color{gray},
  }
}
\NewTColorBox{OutPut}{ m !o !O{DeepSkyBlue3} }{%
  enhanced, colframe=Snow4,
  toptitle=-1mm, bottomtitle=-1mm,
  righttitle=-1mm, lefttitle=-1mm,
  arc=.5mm, colback=white, 
  title={\tcbox[on line, arc=.5mm, boxsep=0pt, boxrule=0pt, 
    top=1mm, bottom=0.8mm, left=2mm, right=2.2mm, 
    colback=gray!40, coltext=DeepSkyBlue3]{\raisebox{-.04\zw}{\KKfbox@SourceCode@phantom#1}}%
  },
  fonttitle=\gtfamily\footnotesize, boxrule=0.8pt,
  breakable, top=-0.5mm, bottom=-0.5mm,
  after title=\IfNoValueTF{#2}{}{{\hfill%
    \tcbox[on line, arc=.5mm, boxsep=0pt, boxrule=0pt, 
    top=1mm, bottom=0.8mm, left=2mm, right=2.2mm, 
    colback=white!80!black, coltext=#3]{\raisebox{-.04\zw}{\KKfbox@SourceCode@phantom#2}}}%
  }, 
  bottom=2mm, top=2mm, 
}
\makeatother
%%%


%%% titlepage
\title{\texttt{KKluaverb} Package Documentation}
\author{Kosei Kawaguchi a.k.a. KKTeX}
\date{Version 1.5.0 (2026/01/12)}
%%%

\begin{document}
%%% title and toc
\begin{titlepage}
  \maketitle
\end{titlepage}
\newpage
\tableofcontents
\newpage
%%%

\section{Outline}
\KKverb|KKluaverb| is a LaTeX package which provides a Lua-enhanced \KKverb|\verb| command, \KKverb|\KKverb|. \thinHighLight{It can be used in the table of contents, index, underline commands (e.g., \KKverb|\underLineKK| provided by the luwa-ul package), \KKverb|tblr| environment and so on.}

\section{Acknowledgements / Credit}
In devoloping this package, I made use of an algorithm which is used in ``bxrawstr'' (by Takayuki YATO)\footnote{%
package: \url{https://gist.github.com/zr-tex8r/c7901658a866adfcd3cd66b6dfa86997}\par
article: \url{https://zrbabbler.hatenablog.com/entry/20181222/1545495849}}.

\section{Usage}
\subsection{Basical useage}
As mentioned in the ``Outline'' seciton, this package mainly provides enhanced \KKverb|\verb| command. The usage is not much different from the normal one.

\KKvScanOff
\begin{SourceCode}{Input}{TeX}
  \KKverb|\def\TEST{Test Text.}|
\end{SourceCode}
\KKvScanOn
\begin{OutPut}{Output}
  \KKverb|\def\TEST{Test Text.}|
\end{OutPut}

\subsection{In Verbatim Environments}
When this package is loaded, the Lua-sccaning which enables \KKverb|\KKverb| to detokenize its argument is activated.
However, when the \KKverb|\KKverb| used in verbatim environments such as ``listings'' and ``tcblisting'', the argument cannot be decoded properly.
\namiKK{In such cases, you should use \KKverb|\KKvScanOff| which deactivates the sccaning process used internally in \KKverb|KKverb.lua|.}

% \subsection{Optional useage}
% 書きかけ

\end{document}

