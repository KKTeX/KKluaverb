% KKluaverb.sty

% Commands for usr: KKv-
% Commands for system: KKlv-

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{KKluaverb}[2026/01/08 v1.4.0]

%%% package
\RequirePackage{luatexbase}
\RequirePackage{pgfkeys, xcolor}
\directlua{require("KKluaverb")}
%%%

%%% kvop
\pgfkeys{
  /kklv/.is family, /kklv/.cd,
  font/.store in  = \kklv@set@font,
  color/.store in = \kklv@set@color,
}
\newcommand{\KKvOpChange}[1]{\pgfkeys{/kklv/.cd, #1}}
\KKvOpChange{font=\ttfamily, color=black}
%%%

%%% def delims
\newtoks\kklv@delims
\newcommand{\KKvSetDelims}[2]{\kklv@delims{{#1}{#2}}}
\KKvSetDelims{|}{|}
%%%

%%% linebreak op
\newtoks\kklv@linebreak
\newcommand{\KKvSetLineBreak}[1]{%
  \ifnum#1<0 \kklv@error@invalidlb{#1}\else
  \ifnum#1>2 \kklv@error@invalidlb{#1}\else
    \kklv@linebreak={#1}%
  \fi\fi
}
\newcommand{\kklv@error@invalidlb}[1]{%
  \PackageError{KKluaverb}{%
    Invalid value '#1' for LineBreak%
  }{%
    LineBreak must be 0 (none), 1 (paragraph), or 2 (with line numbers).%
  }%
}
\KKvSetLineBreak{0}
  % If the op is 0, the line break appears as nothing.  
  % If the op is 1, the line break appears as real linebreak.
  % If the op is 2, the line break appears as real linebreak and line-number-index.

% visualised linenumbers
\pgfkeys{
  /kklvlinenumber/.is family, /kklvlinenumber/.cd,
  font/.store in  = \kklvlinenumber@set@font,
  color/.store in = \kklvlinenumber@set@color,
  size/.store in = \kklvlinenumber@set@size
}
\newcommand{\KKvLNChange}[1]{\pgfkeys{/kklvlinenumber/.cd, #1}}
\KKvLNChange{font=\ttfamily, color=black!80, size=\small}
\newcommand{\KKlvLineNumber}[1]{{%
  \kklvlinenumber@set@font%
  \color{\kklvlinenumber@set@color}%
  \kklvlinenumber@set@size%
  #1%
}}
%%%

%%% replacer
\def\kklv@lua@str#1{"\luatexluaescapestring{#1}"}
\newcommand{\KKvSetMap}[2]{%
  \directlua{KKLuaVerb.add_replacement(\kklv@lua@str{#1}, \kklv@lua@str{#2})}%
}
%%%

%%% main
% When the scanned chunk includes
% a \KKlvStart*<text>\KKlvEnd* part,
% it is transformed as follows:
\long\def\KKlvStart*#1\KKlvEnd*{%
  \ifx\protect\relax%
    \begingroup%
      \kklv@set@font%
      \color{\kklv@set@color}%
      \directlua{
        KKLuaVerb.decode([[#1]])
      }%
    \endgroup%
  \else% 
    % in .toc
    \noexpand\KKlvStart*#1\noexpand\KKlvEnd*%
  \fi%
}
% Run KKLuaVerb.scanner on each line.
\directlua{
  luatexbase.add_to_callback(
    "process_input_buffer",
    KKLuaVerb.scanner, 
    "kkluaverb_scanner"
  )
}
\newcommand{\KKverb}{} 
%%%
\endinput