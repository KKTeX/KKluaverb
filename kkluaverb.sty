% KKluaverb.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{KKluaverb}[2026/01/08 v1.3.0]

%%% package
\RequirePackage{luatexbase}
\RequirePackage{pgfkeys, xcolor}
\directlua{require("KKluaverb")}
%%%

%%% kvop
\pgfkeys{
  /kklv/.is family, /kklv/.cd,
  font/.store in  = \kklv@set@font,
  color/.store in = \kklv@set@color,
}
\newcommand{\KKvOpChange}[1]{\pgfkeys{/kklv/.cd, #1}}
\KKvOpChange{font=\ttfamily, color=black}
%%%

%%% def delims
\newtoks\kklv@delims
\newcommand{\KKvSetDelims}[2]{\kklv@delims{{#1}{#2}}}
\KKvSetDelims{|}{|}
%%%

%%% replacer
\def\kklv@lua@str#1{"\luatexluaescapestring{#1}"}
\newcommand{\KKvSetMap}[2]{%
  \directlua{KKLuaVerb.add_replacement(\kklv@lua@str{#1}, \kklv@lua@str{#2})}%
}
%%%

%%% main
\def\KKlvStart*#1\KKlvEnd*{%
  \begingroup%
    \kklv@set@font%
    \color{\kklv@set@color}%
    \directlua{KKLuaVerb.decode([[#1]])}%
  \endgroup%
}
\directlua{
  luatexbase.add_to_callback("process_input_buffer",
  KKLuaVerb.scanner, "kkluaverb_scanner")
}
\newcommand{\KKverb}{} 
%%%

\endinput