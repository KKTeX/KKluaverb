% KKluaverb.sty
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{KKluaverb}[2026/01/08 v1.3.0]

%%% package
\RequirePackage{luatexbase}
\RequirePackage{pgfkeys, xcolor}
\directlua{require("KKluaverb")}
%%%

%%% kvop
\pgfkeys{
  /kklv/.is family, /kklv/.cd,
  font/.store in  = \kklv@set@font,
  color/.store in = \kklv@set@color,
}
\newcommand{\KKvOpChange}[1]{\pgfkeys{/kklv/.cd, #1}}
\KKvOpChange{font=\ttfamily, color=black}
%%%

%%% def delims
\newtoks\kklv@delims
\newcommand{\KKvSetDelims}[2]{\kklv@delims{{#1}{#2}}}
\KKvSetDelims{|}{|}
%%%

%%% linebreak op
\newtoks\kklv@linebreak
\newcommand{\KKvSetLineBreak}[1]{\kklv@linebreak={#1}}
\KKvSetLineBreak{0}
  % If the op is 1, the line break appears as real linebreak.
  % If the op is 0, the line break appears as nothing.
%%%

%%% replacer
\def\kklv@lua@str#1{"\luatexluaescapestring{#1}"}
\newcommand{\KKvSetMap}[2]{%
  \directlua{KKLuaVerb.add_replacement(\kklv@lua@str{#1}, \kklv@lua@str{#2})}%
}
%%%

%%% main
\def\KKlvStart*#1\KKlvEnd*{%
  \ifx\protect\relax%
    \begingroup%
      \kklv@set@font%
      \color{\kklv@set@color}%
      \directlua{
        KKLuaVerb.decode([[#1]])
      }%
    \endgroup%
  \else% 
    % in toc
    \noexpand\KKlvStart*#1\noexpand\KKlvEnd*%
  \fi%
}
\directlua{
  luatexbase.add_to_callback("process_input_buffer",
  KKLuaVerb.scanner, "kkluaverb_scanner")
}
\newcommand{\KKverb}{} 
%%%

\endinput